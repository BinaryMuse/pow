# Authex

Authex is a highly flexible and extendable authentication solution for Phoenix and Plug based apps.

## Features

* User registration
* Session based authorization
* Per Endpoint/Plug configuration
* Extendable
* I18n

## Installation

Add Authex to your list of dependencies in `mix.exs`:

```elixir
def deps do
  [
    # ...
    {:authex, "~> 0.1"}
    # ...
  ]
end
```

Run `mix deps.get` to install it.

## Getting started

Install the necessary files:

```bash
mix authex.install
```

This will add the following files to your app:

```bash
LIB_PATH/authex.ex
LIB_PATH/users/user.ex
PRIV_PATH/repo/migrations/TIMESTAMP_create_user.ex
```

Set up `endpoint.ex` to enable session based authentication:

```elixir
defmodule MyAppWeb.Endpoint do
  use Phoenix.Endpoint, otp_app: :my_app

  # ...

  plug Plug.Session,
    store: :cookie,
    key: "_my_project_demo_key",
    signing_salt: "secret"

  plug MyApp.Authex.Plug.Session

  # ...
end
```

And add the Authex routes and plugs to `router.ex`:

```elixir
defmodule MyAppWeb.Router do
  use MyAppWeb, :router
  use MyApp.Authex.Phoenix.Router

  # ...

  pipeline :protected do
    plug Authex.Plug.RequireAuthenticated
  end

  scope "/" do
    pipe_through :browser

    authex_routes()
  end

  # ...

  scope "/", MyAppWeb do
    pipe_through [:browser, :protected]

    # Protected routes ...
  end
end
```

That's it! Run `mix ecto.setup`, and you can now visit `http://localhost:4000/registrations/new`, and create a new user.

By default, Authex will only expose files that are absolutely necessary, but you can expose other files such as views and templates using the `mix authex.phoenix.install` command.

## Configuration

Authex is build to be modular, and easy to configure. Configuration is primarily passed through method calls, and plug options and they will take priority over any environment configuration. This is ideal in case you've an umbrella app with multiple separate user domains.

### Module groups

Authex has three main groups of modules that each can used individually, or in conjunction with each other:

#### Authex.Plug

This group will handle the plug connection. The configuration will be assigned to `conn.private[:authex_config]` and passed through the controller to the users context module.

#### Authex.Ecto

This group contains all modules related to the Ecto based user schema and context. By default, Authex will use the `Authex.Ecto.Context` module for authenticating, creating, updating and deleting users. However, it's very simple to extend, or write your own user context. You can do this by setting the `:users_context` configuration key.

#### Authex.Phoenix

This contains the controllers, views and templates for Phoenix. Templates are not generated by default, instead compiled default templates will be used. You can choose to generate these by running `mix authex.phoenix.install --templates`.

### Authorization plug

Authex ships with a session plug module. You can easily switch it out with a different one. As an example, here's how you do that with [Guardian](https://github.com/ueberauth/guardian):

```elixir
defmodule MyAppWeb.Authex.Plug do
  use Authex.Plug.Base

  def fetch(conn, config) do
    MyApp.Guardian.Plug.current_resource(conn)
  end

  def create(conn, user, config) do
    MyApp.Guardian.Plug.sign_in(conn, user)
  end

  def delete(conn, config) do
    MyApp.Guardian.Plug.sign_out(conn)
  end
end

defmodule MyAppWeb.Endpoint do
  # ...

  plug MyAppWeb.Authex.Plug,
    repo: MyApp.Repo,
    user: MyApp.Users.User
end
```

### Changeset

The user module has a fallback `changeset/2` method. If you need to add custom validations, you can use the  `authex_changeset/2` method like this:

```elixir
defmodule MyApp.Users.User do
  use Ecto.Schema
  use Authex.Ecto.Schema

  schema "users" do
    field :custom, :string

    authex_user_fields()

    timestamps()
  end

  def changeset(user_or_changeset, attrs) do
    user
    |> authex_changeset(attrs)
    |> Ecto.Changeset.cast(attrs, [:custom])
    |> Ecto.Changeset.validate_required([:custom])
  end
end
```

## Plugs

### Authex.Plug.Session

Enables session based authorization. The user struct will be collected from an ETS table through a GenServer using a unique token generated for the session. The token will be reset every time the authorization level changes.

### Authex.Plug.RequireAuthenticated

By default, this will redirect the user to the log in page if the user hasn't been authenticated.

### Authex.Plug.RequireNotAuthenticated

By default, this will redirect the user to the front page if the user is already authenticated.


## Extensions

Authex is made so it's easy to extend the functionality with your own complimentary library. An example is [`authex_roles`]() that makes it possible to add roles to users.

In general extensions follow these requirements:

* Add